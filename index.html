<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    <link rel="manifest" href="manifest.json">
    <script>
  	if ('serviceWorker' in navigator) {
    	navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker registered'))
      .catch(err => console.error('Service Worker error:', err));
  	}
   </script>
    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© Google APIs Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Google Drive -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- ØªØ­Øª Ø³ÙƒØ±ÙŠØ¨Øª Google APIs -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        :root {
            --primary-green: #2E8B57;
            --light-green: #E8F5E8;
            --sky-blue: #87CEEB;
            --dark-blue: #4682B4;
            --white: #FFFFFF;
            --black: #333333;
            --gray: #F5F5F5;
            --red: #FF4444;
        }

        body {
            background: var(--light-green);
            color: var(--black);
            line-height: 1.6;
        }
        

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ */
        #authModal {
            position: fixed;
            top: 0; right: 0; bottom: 0; left: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .auth-box {
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            width: 300px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .auth-box input {
            width: 90%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            border: 1px solid #b2dfdb; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
            border-radius: 5px;
        }

        .auth-box button {
            padding: 10px 20px;
            font-size: 16px;
            background: #b2dfdb; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
            color: #004d40;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #errorMsg {
            color: #ef9a9a; /* Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
            margin-top: 10px;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        }

        /* ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== */
        .header {
            text-align: center;
            background: var(--primary-green);
            color: var(--white);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
        .btn {
            background: var(--sky-blue);
            color: var(--black);
            border: none;
            padding: 15px 20px;
            margin: 10px 0;
            width: 100%;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn:active {
            background: var(--dark-blue);
            transform: scale(0.98);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
        }
        
        .btn-secondary {
            background: #CCCCCC;
            color: var(--black);
        }

        /* ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª ===== */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ===== */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-green);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #DDD;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--sky-blue);
            outline: none;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* ===== Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ===== */
        .search-box {
            margin: 15px 0;
            position: relative;
        }

        .search-box input {
            padding-right: 40px;
        }

        /* ===== Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ===== */
        .list-container {
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .list-item {
            padding: 15px;
            border-bottom: 1px solid #EEE;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: var(--gray);
        }

        .client-name {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-green);
        }

        .client-debt {
            color: var(--red);
            font-weight: bold;
        }

        .transaction-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ===== */
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-buttons .btn {
            flex: 1;
        }

        /* ===== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0; 
		right: 0; 
		bottom: 0;


            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
justify-content: center;
    align-items: center;


            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;

            /* Ø§Ù„Ø­Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ */
            max-height: 80vh;       /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ 80% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            overflow-y: auto;       /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
        }
        .close {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .results {
            margin-top: 15px;
        }



        /* ===== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }

        .stat-item {
            background: var(--white);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-green);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        /* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© ===== */
        .bottom-tools {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 10px 15px;
            border-top: 1px solid #DDD;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .tool-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø«Ø§Ù†ÙˆÙŠØ© ØµØºÙŠØ±Ø© */
        .btn-mini {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
            background: #f0f0f0;
            color: #222;
            border: 1px solid #ddd;
            cursor: pointer;
            box-shadow: none;
            transition: background .15s, transform .08s;
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø®Ø§ØµØ© Ù„Ù„Ù€ Drive / Export */
        .btn-mini.primary { 
            background: #eef9f2; 
            color: #2E8B57; 
            border-color: #d6f0de; 
        }
        
        .btn-mini.secondary { 
            background: #ffffff; 
            color: #555; 
            border-color: #e6e6e6; 
        }
        
        .btn-mini.danger { 
            background: #fff5f5; 
            color: #c0392b; 
            border-color: #f2dede; 
        }

        .btn-mini.google { 
            background: #f1f8ff; 
            color: #1a73e8; 
            border-color: #d2e3fc; 
        }

        /* ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .btn-mini:hover { 
            background: #f7f7f7; 
            transform: translateY(-1px); 
        }

        /* ===== Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ===== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 16px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .tool-bar {
                justify-content: center;
                gap: 6px;
            }
            
            .btn-mini {
                padding: 6px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .btn-mini {
                padding: 6px 8px;
                font-size: 12px;
            }
        }
        
.contact-buttons a {
    display: block;
    margin: 10px auto;
    padding: 10px;
    background-color: #b2dfdb; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
    color: #000;
    border-radius: 5px;
    text-decoration: none;
    width: 80%;
}

.contact-buttons a:hover {
    background-color: #80cbc4;
}


    </style>
</head>
<body>
    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ -->
<div id="authModal">
    <div class="auth-box">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„<br>
       Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø·ÙˆØ± Ø¹Ø¨Ø± Ø§Ù„Ø±Ù‚Ù… -2$<br>963986053607+</h3>
        
        <input type="text" id="codeInput" placeholder="Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚">
        <button onclick="verifyLogin()">Ø¯Ø®ÙˆÙ„</button>
        <div id="errorMsg"></div>
    </div>
</div>


    <!-- ===== Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== -->
    <div class="container">
        
        <!-- ===== Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== -->
        <div id="mainScreen" class="screen active">
            <div class="header">
                <h1>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†</h1>
                <button onclick="showInfoModal()" id = "versionButton" style="color: #004d40; font-family: 'Courier New', Courier, monospace; background-color: #80cbc4;" >v1.7.6</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalDebt">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©</div>
                </div>
            </div>

            <button class="btn" onclick="showScreen('addClientScreen')">Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn" onclick="showScreen('addTransactionScreen')">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn" onclick="showScreen('clientsScreen')">Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
            <button class="btn" onclick="showScreen('transactionsScreen')">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            <button id="showOldDebtsBtn" class="btn btn-warning">Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ø°ÙŠÙ† ØªØ£Ø®Ø±ÙˆØ§ ÙÙŠ Ø§Ù„Ø¯ÙØ¹</button>
            
               <!-- ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© ===== -->
               <div class="tool-bar" id="utilityToolbar">
                <!-- Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
                <button class="btn-mini google" id="googleAuthBtn" onclick="handleGoogleAuth()">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
                </button>
                
                <!-- Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
                <button class="btn-mini primary" id="syncDriveBtn" onclick="syncWithDrive()" style="display:none;">
                    ğŸ”¼ Ø±ÙØ¹ Ø¥Ù„Ù‰ Drive
                </button>
                <button class="btn-mini secondary" id="importDriveBtn" onclick="importFromDrive()" style="display:none;">
                    ğŸ”½ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Drive
                </button>
                
                <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                <input type="file" id="importFile" accept=".json" style="display:none;">
                <button class="btn-mini" onclick="document.getElementById('importFile').click()">
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù
                </button>
                <button class="btn-mini primary" onclick="exportDataToFile()">
                    ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>

        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† ===== -->
        <div id="addClientScreen" class="screen">
            <div class="header">
                <h1>Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h1>
            </div>

            <div class="form-group">
                <label for="clientName">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:</label>
                <input type="text" id="clientName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
            </div>

            <button class="btn" onclick="addClient()">Ø­ÙØ¸ Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ===== -->
        <div id="addTransactionScreen" class="screen">
            <div class="header">
                <h1>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            </div>

            <div class="form-group">
                <label for="transactionClientInput">Ø§Ø®ØªØ± Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‡:</label>
                <input type="text" id="transactionClientInput" class="form-control" autocomplete="off" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯">
                <input type="hidden" id="transactionClientId">
                <div id="transactionSuggestions" class="list-container" style="display:none; position:relative; max-height:200px; overflow:auto;"></div>
            </div>
            
            <div class="form-group">
                <label for="isPayment">Ø¯ÙØ¹:</label>
                <input type="checkbox" id="isPayment">
            </div>
            
            <div class="form-group">
                <label for="transactionAmount">Ø§Ù„Ù…Ø¨Ù„Øº :</label>
                <input type="number" id="transactionAmount" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
            </div>

            <div class="form-group">
                <label for="transactionNotes">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</label>
                <textarea id="transactionNotes" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"></textarea>
            </div>

            <button class="btn" onclick="addTransaction()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ===== -->
        <div id="clientsScreen" class="screen">
            <div class="header">
                <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h1>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

            <div class="search-box">
                <input type="text" id="searchClient" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ†...">
            </div>

            <div id="clientsList" class="list-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† -->
            </div>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ===== -->
        <div id="transactionsScreen" class="screen">
            <div class="header">
                <h1>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            
            <div class="search-box">
                <input type="text" id="searchTransaction" class="form-control" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...">
            </div>

            <div id="transactionsList" class="list-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
            </div>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯ ===== -->
        <div id="clientTransactionsScreen" class="screen">
            <div class="header">
                <h1 id="clientTransactionsTitle">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†</h1>
            </div>

            <div class="list-container">
                <div class="client-info">
                    <div class="client-name" id="currentClientName"></div>
                    <div class="client-debt" id="currentClientDebt"></div>
                    <button class="btn" onclick="showEditClientName()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
                    <button class="btn" onclick="startTransactionForCurrentClient()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
            </div>

            <div id="clientTransactionsList" class="list-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† -->
            </div>

            <button id="back" class="btn btn-secondary" onclick="showScreen('clientsScreen')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
        </div>
    </div>

    <!-- ===== Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===== -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="color: var(--primary-green); margin-bottom: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2>
            
            <div class="form-group">
                <label for="editAmount">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
                <input type="number" id="editAmount" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="editisPayment">Ø¯ÙØ¹:</label>
                <input type="checkbox" id="editisPayment">
            </div>
            
            <div class="form-group">
                <label for="editNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                <textarea id="editNotes" class="form-control"></textarea>
            </div>

            <div class="nav-buttons">
                <button class="btn" onclick="updateTransaction()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- ===== Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† ===== -->
    <div id="editClientNameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditClientNameModal()">&times;</span>
            <h2 style="color: var(--primary-green); margin-bottom: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</h2>
    
            <div class="form-group">
                <label for="editClientName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                <input type="text" id="editClientName" class="form-control">
            </div>
    
            <div class="nav-buttons">
                <button class="btn" onclick="updateClientName()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-secondary" onclick="closeEditClientNameModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInfoModal()">Ã—</span>
            <h2>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
            <p>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ† Ù‡Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ù…Ù† ØªØ·ÙˆÙŠØ± ÙŠÙˆÙ†Ø³ Ø®ÙŠØ²Ø±Ø§Ù† . <br> Ø§Ù„Ø¥ØµØ¯Ø§Ø± 1.7.6<br> .*ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ù…Ù†ÙŠØ© Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø³ØªÙ‚Ø± Ø§ÙƒØ«Ø±</p>
            <div class="stats">
                <a  href="https://www.facebook.com/younismkh" target="_blank"><button class="btn-danger">facebook</button></a>

                <a href="mailto:khezaranyounis@outlook.com?subject=Ø·Ù„Ø¨ Ø¯Ø¹Ù…&body= Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£ÙˆØ§Ø¬Ù‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ 1.7.6..." ><button class="btn-mini">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¯Ø¹Ù… Ùˆ Ø§Ù„Ø´ÙƒÙˆÙ‰</button></a>
                
                <a  href="https://www.youtube.com/@youniskhezaran9863" target="_blank"><button class="btn-danger">youtube</button></a>
            </div>
        </div>
    </div>
    <div id="oldDebtsModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span id="closeOldDebtsModal" class="close">&times;</span>
          <h3>Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</h3>
          <select id="debtPeriodSelect">
            <option value="30">Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±</option>
            <option value="60">Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±ÙŠÙ†</option>
            <option value="90">Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£Ø´Ù‡Ø±</option>
            <option value="180">Ø£ÙƒØ«Ø± Ù…Ù† 6 Ø£Ø´Ù‡Ø±</option>
            <option value="365">Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©</option>
          </select>
          <button id="filterDebtorsBtn" class="btn btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
          <div id="debtorResults" class="results"></div>
        </div>
        
        
        
      </div>
    <script>
        // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
        let clients = JSON.parse(localStorage.getItem('debtClients')) || [];
        let transactions = JSON.parse(localStorage.getItem('debtTransactions')) || [];
        let currentClientId = null;
        let currentTransactionId = null;
        let isGoogleAuthenticated = false;
        let googleAccessToken = null;

        // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            loadClientsForTransaction();
            displayClients();
            displayTransactions();
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø¨Ø­Ø«
            document.getElementById('searchClient').addEventListener('input', filterClients);
            document.getElementById('searchTransaction').addEventListener('input', filterTransactions);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Google Drive
            setupGoogleDriveButtons();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
            setupFileButtons();
            // 
        });
        document.getElementById('showOldDebtsBtn').onclick = () => {
            document.getElementById('oldDebtsModal').style.display = 'block';
            };
            //
            
        document.getElementById('closeOldDebtsModal').onclick = () => {
            document.getElementById('oldDebtsModal').style.display = 'none';
            };
            //
   function showInfoModal() {
    const modal = document.getElementById("infoModal");
    if (modal) {
      modal.style.display = "block";
    }
  }

  function closeInfoModal() {
    const modal = document.getElementById("infoModal");
    if (modal) {
      modal.style.display = "none";
    }
  }

  window.onload = () => {
    const versionBtn = document.getElementById("versionButton");
    const closeBtn = document.getElementById("closeInfoModal");

    if (versionBtn) {
      versionBtn.onclick = showInfoModal;
    }

    if (closeBtn) {
      closeBtn.onclick = closeInfoModal;
    }
  };


        
        // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª =====
        function showScreen(screenId) {
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.style.display = 'block';
            }

            // ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ø®Ø±Ø¬Ù†Ø§ Ù…Ù†Ù‡Ø§
            if (screenId !== 'clientTransactionsScreen') {
                clearClientTransactionsScreen();
            }

            if (screenId === 'clientsScreen') {
                displayClients();
            } else if (screenId === 'transactionsScreen') {
                displayTransactions();
            } else if (screenId === 'addTransactionScreen') {
                loadClientsForTransaction();
            }
        }

        function clearClientTransactionsScreen() {
            document.getElementById('currentClientName').textContent = '';
            document.getElementById('currentClientDebt').textContent = '';
            document.getElementById('clientTransactionsTitle').textContent = 'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†';
            document.getElementById('clientTransactionsList').innerHTML = '';
            currentClientId = null;
        }

        // ===== Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯ =====
        function addClient() {
            const nameInput = document.getElementById('clientName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†');
                return;
            }
            
            const newClient = {
                id: Date.now(),
                name: name,
                currentDebt: 0
            };
            
            clients.push(newClient);
            saveData();
            nameInput.value = '';
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­');
            showScreen('mainScreen');
            updateStats();
        }

        // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© =====
        function loadClientsForTransaction(selectedClientId = null) {
            const input = document.getElementById('transactionClientInput');
            const suggestions = document.getElementById('transactionSuggestions');
            input.value = '';
            document.getElementById('transactionClientId').value = '';

            // Ø¨Ù†Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
            suggestions.innerHTML = '';
            clients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.style.cursor = 'pointer';
                item.textContent = `${client.name} (Ø¯ÙŠÙ† Ø­Ø§Ù„Ù‰: ${client.currentDebt})`;
                item.dataset.clientId = client.id;
                item.addEventListener('click', () => {
                    input.value = client.name;
                    document.getElementById('transactionClientId').value = client.id;
                    suggestions.style.display = 'none';
                });
                suggestions.appendChild(item);
            });

            // Ù„Ùˆ Ù…Ø±Ø±Ù†Ø§ selectedClientId Ù…Ù† startTransactionForCurrentClient
            if (selectedClientId) {
                const client = clients.find(c => c.id === selectedClientId);
                if (client) {
                    input.value = client.name;
                    document.getElementById('transactionClientId').value = client.id;
                }
            }
        }

        // ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© =====
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('transactionClientInput');
            const suggestions = document.getElementById('transactionSuggestions');

            // Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø©
            input.addEventListener('focus', () => {
                if (suggestions.children.length) suggestions.style.display = 'block';
            });

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ
            input.addEventListener('input', () => {
                const q = input.value.trim().toLowerCase();
                let anyVisible = false;
                Array.from(suggestions.children).forEach(item => {
                    const name = item.textContent.toLowerCase();
                    if (!q || name.includes(q)) {
                        item.style.display = 'block';
                        anyVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                suggestions.style.display = anyVisible ? 'block' : 'none';
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ø°Ø§ ØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹
                if (!q) {
                    document.getElementById('transactionClientId').value = '';
                } else {
                    const exact = clients.find(c => c.name.toLowerCase() === q);
                    document.getElementById('transactionClientId').value = exact ? exact.id : '';
                }
            });

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#transactionSuggestions') && !e.target.closest('#transactionClientInput')) {
                    suggestions.style.display = 'none';
                }
            });
        });

        // ===== Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© =====
        function addTransaction() {
            const clientIdHidden = document.getElementById('transactionClientId').value;
            const clientId = parseInt(clientIdHidden, 10);
            const amountInput = document.getElementById('transactionAmount');
            const notesInput = document.getElementById('transactionNotes');
            const isPaymentCheckbox = document.getElementById('isPayment');

            let amount = parseFloat(amountInput.value);
            let NotesIfPay="";
            
            const notes = notesInput.value.trim();
            const isPayment = isPaymentCheckbox.checked;
            NotesIfPay = isPayment ? "....Ø¯ÙØ¹ ...."+notes : notes
            if (!clientId || isNaN(amount) || NotesIfPay=="") {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø²Ø¨ÙˆÙ† ØµØ§Ù„Ø­ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                return;
            }

            amount = isPayment ? -Math.abs(amount) : Math.abs(amount);

            const newTransaction = {
                id: Date.now(),
                clientId: clientId,
                amount: amount,
                notes: NotesIfPay,
                dateTime: new Date().toLocaleString('ar-EG')
            };

            transactions.push(newTransaction);

            const client = clients.find(c => c.id === clientId);
            if (client) client.currentDebt += amount;

            saveData();

            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('transactionClientInput').value = '';
            document.getElementById('transactionClientId').value = '';
            amountInput.value = '';
            notesInput.value = '';
            isPaymentCheckbox.checked = false;

            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
            showScreen('mainScreen');
            updateStats();
        }

        // ===== Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† =====
        function displayClients() {
            document.getElementById('back').style.display = 'none';
            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = '';
            
            clients.forEach(client => {
                const clientItem = document.createElement('div');
                clientItem.className = 'list-item';
                clientItem.innerHTML = `
                    <div class="client-name">${client.name}</div>
                    <div class="client-debt">Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${client.currentDebt}</div>
                `;
                clientItem.onclick = () => showClientTransactions(client.id);
                clientsList.appendChild(clientItem);
            });
        }

        // ===== Ø¹Ø±Ø¶ Ø¹Ù…Ù„ÙŠØ§Øª Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯ =====
        function showClientTransactions(clientId) {
            document.getElementById('back').style.display = 'inline-block';
            currentClientId = clientId;
            const client = clients.find(c => c.id === clientId);
            
            if (client) {
                document.getElementById('currentClientName').textContent = client.name;
                document.getElementById('currentClientDebt').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙ†: ${client.currentDebt}`;
                document.getElementById('clientTransactionsTitle').textContent = `Ø¹Ù…Ù„ÙŠØ§Øª ${client.name}`;
            }
            
            const transactionsList = document.getElementById('clientTransactionsList');
            transactionsList.innerHTML = '';
            
            const clientTransactions = transactions.filter(t => t.clientId === clientId);
            
            clientTransactions.slice().reverse().forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'list-item';
                transactionItem.innerHTML = `
                    <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${transaction.amount}</div>
                    <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${transaction.dateTime}</div>
                    <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${transaction.notes}</div>
                `;
                transactionItem.onclick = () => editTransaction(transaction.id);
                transactionsList.appendChild(transactionItem);
            });
            
            showScreen('clientTransactionsScreen');
        }

        // ===== Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª =====
        function displayTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '';
            
            transactions.slice().reverse().forEach(transaction => {
                const client = clients.find(c => c.id === transaction.clientId);
                const clientName = client ? client.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                const transactionItem = document.createElement('div');
                transactionItem.className = 'list-item';
                transactionItem.innerHTML = `
                    <div><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> ${clientName}</div>
                    <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${transaction.amount}</div>
                    <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${transaction.dateTime}</div>
                    <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${transaction.notes.substring(0, 50)}${transaction.notes.length > 50 ? '...' : ''}</div>
                `;
                transactionItem.onclick = () => editTransaction(transaction.id);
                transactionsList.appendChild(transactionItem);
            });
        }

        // ===== ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© =====
        function editTransaction(transactionId) {
            currentTransactionId = transactionId;
            const transaction = transactions.find(t => t.id === transactionId);

            if (transaction) {
                // Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ù…Ø®Ø²Ù†Ù†Ø§ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨ Ù„Ù„Ø¯ÙØ¹ØŒ Ù„ÙƒÙ† Ù†Ø¹Ø±Ø¶Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¹ ØªØ¹ÙŠÙŠÙ† checkbox
                document.getElementById('editAmount').value = Math.abs(transaction.amount);
                document.getElementById('editNotes').value = transaction.notes;

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø³Ø§Ù„Ø¨Ø§Ù‹ ÙÙ‡Ùˆ Ø¯ÙØ¹Ø© => checkbox Ù…ÙØ¹Ù„
                document.getElementById('editisPayment').checked = transaction.amount < 0;

                // Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                document.getElementById('editTransactionModal').style.display = 'block';
            }
        }

        // ===== ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ù„Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯ =====
        function startTransactionForCurrentClient() {
            if (!currentClientId) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯');
                return;
            }
            loadClientsForTransaction(currentClientId); // Ø³ÙŠÙ…Ù„Ø£ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
            showScreen('addTransactionScreen');
            // ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº
            setTimeout(() => document.getElementById('transactionAmount').focus(), 100);
        }

        // ===== Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… =====
        function showEditClientName() {
            const client = clients.find(c => c.id === currentClientId);
            if (client) {
                document.getElementById('editClientName').value = client.name;
                document.getElementById('editClientNameModal').style.display = 'block';
            }
        }

        function closeEditClientNameModal() {
            document.getElementById('editClientNameModal').style.display = 'none';
        } 
        
        function updateClientName() {
            const newName = document.getElementById('editClientName').value.trim();
            if (!newName) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ§Ù„Ø­');
                return;
            }

            const client = clients.find(c => c.id === currentClientId);
            if (client) {
                client.name = newName;
                saveData();
                closeEditClientNameModal();
                alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
                showClientTransactions(currentClientId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                updateStats();
            }
        }

        // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ© =====
        function updateTransaction() {
            const amountInput = document.getElementById('editAmount');
            const notesInput = document.getElementById('editNotes');
            const isPaymentCheckbox = document.getElementById('editisPayment');

            const rawAmount = parseFloat(amountInput.value);
            const notes = notesInput.value.trim();
            const isPayment = isPaymentCheckbox.checked;

            if (isNaN(rawAmount) || !notes) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }

            const updatedAmount = isPayment ? -Math.abs(rawAmount) : Math.abs(rawAmount);

            const transactionIndex = transactions.findIndex(t => t.id === currentTransactionId);
            if (transactionIndex !== -1) {
                const oldAmount = transactions[transactionIndex].amount;
                transactions[transactionIndex].amount = updatedAmount;
                transactions[transactionIndex].notes = notes;

                const client = clients.find(c => c.id === transactions[transactionIndex].clientId);
                if (client) {
                    // Ù†Ø¶ÙŠÙ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                    client.currentDebt += (updatedAmount - oldAmount);
                }

                saveData();
                closeModal();
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');

                if (currentClientId) {
                    showClientTransactions(currentClientId);
                } else {
                    displayTransactions();
                }
                updateStats();
            }
        }

        // ===== Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =====
        function closeModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
        }

        // ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† =====
        function filterClients() {
            const searchText = document.getElementById('searchClient').value.toLowerCase();
            const clientItems = document.querySelectorAll('#clientsList .list-item');
            
            clientItems.forEach(item => {
                const clientName = item.querySelector('.client-name').textContent.toLowerCase();
                if (clientName.includes(searchText)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª =====
        function filterTransactions() {
            const searchText = document.getElementById('searchTransaction').value.toLowerCase();
            const transactionItems = document.querySelectorAll('#transactionsList .list-item');
            
            transactionItems.forEach(item => {
                const itemText = item.textContent.toLowerCase();
                if (itemText.includes(searchText)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =====
        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            
            const totalDebt = clients.reduce((sum, client) => sum + client.currentDebt, 0);
            document.getElementById('totalDebt').textContent = totalDebt.toFixed(2);
        }

        // ===== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage =====
        function saveData() {
            localStorage.setItem('debtClients', JSON.stringify(clients));
            localStorage.setItem('debtTransactions', JSON.stringify(transactions));
        }

        // ===== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
        function closeApp() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ø¹Ø§Ø¯ÙŠ
                window.close();
                // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰ APKØŒ Ù‡Ø°Ø§ Ø³ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¦Ø©
            }
        }

        // ===== Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©æ„å¤–ÙŠ =====
        window.addEventListener('beforeunload', function (e) {
            e.preventDefault();
            e.returnValue = '';
        });

        // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª =====
        function setupFileButtons() {
            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¯Ù…Ø¬ Ù…Ù„Ù JSON
            document.getElementById('mergeFileBtn').addEventListener('click', async () => {
                const input = document.getElementById('importFile');
                if (!input.files || !input.files[0]) return alert('Ø§Ø®ØªØ± Ù…Ù„Ù JSON Ø£ÙˆÙ„Ø§Ù‹');
                try {
                    const text = await input.files[0].text();
                    const parsed = JSON.parse(text);

                    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
                    const incomingClients = Array.isArray(parsed.clients) ? parsed.clients : [];
                    const incomingTransactions = Array.isArray(parsed.transactions) ? parsed.transactions : [];

                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: Ø¥Ø°Ø§ ÙƒØ§Ù† id Ù…ØªØ·Ø§Ø¨Ù‚ Ù„Ø§ ØªØ¶ÙŠÙØŒ Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙŠÙ…ÙƒÙ† Ø¶Ø¨Ø· Ø°Ù„Ùƒ Ù‡Ù†Ø§
                    const existingClientIds = new Set(clients.map(c => c.id));
                    incomingClients.forEach(ic => {
                        if (!existingClientIds.has(ic.id)) {
                            clients.push(ic);
                        } else {
                            // Ù…Ø«Ø§Ù„: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙŠÙ† Ø¥Ù† Ø±ØºØ¨Øª (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                            const existing = clients.find(c => c.id === ic.id);
                            if (existing) {
                                // Ø®ÙŠØ§Ø± 1: Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¡ (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù„Ù) â€” Ø§ÙØ¹Ù„ nothing
                                // Ø®ÙŠØ§Ø± 2: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ù…Ù„Ù:
                                // existing.name = ic.name;
                                // existing.currentDebt = ic.currentDebt;
                            }
                        }
                    });

                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­Ø³Ø¨ id
                    const existingTxnIds = new Set(transactions.map(t => t.id));
                    incomingTransactions.forEach(it => {
                        if (!existingTxnIds.has(it.id)) {
                            transactions.push(it);
                        }
                    });

                    // Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬: Ø­ÙØ¸ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    saveData();
                    updateStats();
                    displayClients();
                    displayTransactions();
                    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                } catch (e) {
                    console.error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', e);
                    alert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø£Ùˆ ØªÙ†Ø³ÙŠÙ‚Ù‡ ØºÙŠØ± ØµØ­ÙŠØ­ JSON');
                }
            });

            // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù JSON
            document.getElementById('exportFileBtn').addEventListener('click', () => {
                exportDataToFile();
            });
        }

        // ===== ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ù…Ù„Ù Ù…Ø¹ Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ =====
        function makeBackupFilename() {
            const now = new Date();
            const ts = now.toISOString().replace(/[:.]/g, '-'); // ØµØ§Ù„Ø­ ÙƒØ§Ø³Ù… Ù…Ù„Ù
            return `debt_backup_${ts}.json`;
        }

        // ===== Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ…Ù„Ù JSON ÙˆØªÙ†Ø²ÙŠÙ„Ù‡ =====
        // ===== Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ APK =====
function exportDataToFile(filename = null) {
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        exportedAt: new Date().toISOString()
    };

    const jsonString = JSON.stringify(data, null, 2);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ù„Ù„Ù…ØªØµÙØ­Ø§Øª)
    try {
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename || makeBackupFilename();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (e) {
        console.log('Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙØ´Ù„ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
    }
    
    // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù„Ù€ APK
    shareData(jsonString, filename);
}

// ===== Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù„Ù€ APK =====
function shareData(jsonString, filename = null) {
    // Ø¥Ù†Ø´Ø§Ø¡ Blob
    const blob = new Blob([jsonString], { type: 'application/json' });
    
    // Ø¥Ù†Ø´Ø§Ø¡ URL Ù„Ù„Ù€ Blob
    const url = URL.createObjectURL(blob);
    
    // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    const finalFilename = filename || makeBackupFilename();
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Share API Ø¥Ø°Ø§ Ù…ØªØ§Ø­
    if (navigator.share && navigator.canShare) {
        try {
            const file = new File([blob], finalFilename, { type: 'application/json' });
            
            if (navigator.canShare({ files: [file] })) {
                navigator.share({
                    files: [file],
                    title: 'ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†',
                    text: 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ¯Ø±Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†'
                }).then(() => {
                    alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ø¨Ù†Ø¬Ø§Ø­');
                }).catch((error) => {
                    console.log('Ù…Ø´Ø§Ø±ÙƒØ© ÙØ´Ù„Øª:', error);
                    showAlternativeOptions(url, finalFilename);
                });
            } else {
                showAlternativeOptions(url, finalFilename);
            }
        } catch (error) {
            console.log('Web Share API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…:', error);
            showAlternativeOptions(url, finalFilename);
        }
    } else {
        showAlternativeOptions(url, finalFilename);
    }
}

// ===== Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø¯ÙŠÙ„Ø© =====
function showAlternativeOptions(url, filename) {
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„ØªÙ†Ø²ÙŠÙ„
    const downloadDiv = document.createElement('div');
    downloadDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
        max-width: 90%;
    `;
    
    downloadDiv.innerHTML = `
        <h3 style="color: #2E8B57; margin-bottom: 15px;">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p style="margin-bottom: 15px;">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</p>
        
        <button onclick="copyToClipboard()" style="
            background: #87CEEB;
            color: black;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        ">Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†ØµÙŠ</button>
        
        <button onclick="openInNewTab('${url}')" style="
            background: #2E8B57;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        ">ÙØªØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        
        <button onclick="saveToLocalStorage()" style="
            background: #FF4444;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        ">Ø­ÙØ¸ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        
        <button onclick="this.parentElement.remove()" style="
            background: #CCCCCC;
            color: black;
            border: none;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        ">Ø¥Ù„ØºØ§Ø¡</button>
    `;
    
    document.body.appendChild(downloadDiv);
}

// ===== Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø© =====
function copyToClipboard() {
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        exportedAt: new Date().toISOString()
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    
    navigator.clipboard.writeText(jsonString).then(() => {
        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©\nÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
        document.querySelector('div').remove();
    }).catch(() => {
        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù†Ø³Ø®
        const textArea = document.createElement('textarea');
        textArea.value = jsonString;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
        document.querySelector('div').remove();
    });
}

function openInNewTab(url) {
    const newWindow = window.open(url, '_blank');
    if (newWindow) {
        alert('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©\nÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¯ÙˆÙŠØ§Ù‹');
    }
    document.querySelector('div').remove();
}

function saveToLocalStorage() {
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        backupDate: new Date().toLocaleString('ar-EG')
    };
    
    localStorage.setItem('debtManualBackup', JSON.stringify(data));
    localStorage.setItem('lastBackupTime', new Date().toISOString());
    
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹');
    document.querySelector('div').remove();
}

// ===== Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© =====
function restoreFromBackup() {
    const backup = localStorage.getItem('debtManualBackup');
    if (!backup) {
        alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©');
        return;
    }
    
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        try {
            const data = JSON.parse(backup);
            clients = data.clients || [];
            transactions = data.transactions || [];
            saveData();
            updateStats();
            displayClients();
            displayTransactions();
            alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            alert('âŒ ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        }
    }
}

        // ===== ÙˆØ¸Ø§Ø¦Ù Google Drive =====
        function setupGoogleDriveButtons() {
            document.getElementById('googleAuthBtn').addEventListener('click', handleGoogleAuth);
            document.getElementById('syncDriveBtn').addEventListener('click', syncWithDrive);
            document.getElementById('importDriveBtn').addEventListener('click', importFromDrive);
        }

        // ===== Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Google =====
        // ===== Ù…ØµØ§Ø¯Ù‚Ø© Google - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù† =====
        function handleGoogleAuth() {
    console.log('ğŸ” Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
    
    if (typeof google === 'undefined') {
        alert('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Google...');
        return;
    }

    try {
        const client = google.accounts.oauth2.initTokenClient({
            client_id: '818632760933-3j6rmg7vui3epuc15nejm7od6mbb37km.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/drive.file',
            prompt: 'consent', // ğŸ”¥ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù…Ù‡Ù… - ÙŠØ¬Ø¨Ø± Ø¸Ù‡ÙˆØ± Ø§Ù„Ù†Ø§ÙØ°Ø©
            callback: (response) => {
                if (response && response.access_token) {
                    // Ù†Ø¬Ø­Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©!
                    googleAccessToken = response.access_token;
                    isGoogleAuthenticated = true;
                    
                    document.getElementById('googleAuthBtn').style.display = 'none';
                    document.getElementById('syncDriveBtn').style.display = 'inline-block';
                    document.getElementById('importDriveBtn').style.display = 'inline-block';
                    
                    alert('ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');
                    console.log('âœ… Token:', response.access_token.substring(0, 20) + '...');
                    
                    // Ø¬Ø±Ø¨ Ù…Ø²Ø§Ù…Ù†Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯
                    setTimeout(() => {
                        syncWithDrive();
                    }, 1000);
                    
                } else {
                    alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„');
                }
            },
            error_callback: (error) => {
                console.error('ğŸ”´ Ø®Ø·Ø£ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
                
                if (error.type === 'popup_closed') {
                    alert('âš ï¸ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©. Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙˆØ§ØªØ±ÙƒÙ‡Ø§ Ù…ÙØªÙˆØ­Ø©.');
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + JSON.stringify(error));
                }
            }
        });
        
        console.log('ğŸ”„ Ø·Ù„Ø¨ token Ù…Ø¹ prompt...');
        client.requestAccessToken();
        
    } catch (error) {
        console.error('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø©:', error);
        alert('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message);
    }
}

        // ===== Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Drive =====
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
function syncWithDrive() {
    if (!isGoogleAuthenticated) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    console.log('ğŸ”¼ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Drive...');
    
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        lastSync: new Date().toLocaleString('ar-EG')
    };

    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });

    findOrCreateDriveFile(blob)
        .then(() => {
            alert('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Drive Ø¨Ù†Ø¬Ø§Ø­');
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:', error);
            alert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        });
}


        // ===== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙÙŠ Drive =====
        function findOrCreateDriveFile(blob) {
            return new Promise((resolve, reject) => {
                gapi.client.drive.files.list({
                    q: "name='debt_backup.json' and trashed=false",
                    fields: 'files(id, name)'
                }).then(response => {
                    const files = response.result.files;
                    
                    if (files.length > 0) {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                        updateDriveFile(files[0].id, blob).then(resolve).catch(reject);
                    } else {
                        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                        createDriveFile(blob).then(resolve).catch(reject);
                    }
                }).catch(reject);
            });
        }

        // ===== ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Drive =====
        function updateDriveFile(fileId, blob) {
            return new Promise((resolve, reject) => {
                const metadata = {
                    name: 'debt_backup.json',
                    mimeType: 'application/json'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    },
                    body: form
                }).then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        reject(new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive'));
                    }
                }).catch(reject);
            });
        }

        // ===== Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙÙŠ Drive =====
        function createDriveFile(blob) {
            return new Promise((resolve, reject) => {
                const metadata = {
                    name: 'debt_backup.json',
                    mimeType: 'application/json'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    },
                    body: form
                }).then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        reject(new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive'));
                    }
                }).catch(reject);
            });
        }

        // ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive =====
        function importFromDrive() {
    if (!isGoogleAuthenticated) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    if (!confirm('âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
        return;
    }

    console.log('ğŸ”½ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Drive...');
    
    gapi.client.drive.files.list({
        q: "name='debt_backup.json' and trashed=false",
        fields: 'files(id, name)'
    }).then(response => {
        const files = response.result.files;
        
        if (files.length === 0) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Drive');
            return;
        }

        fetch(`https://www.googleapis.com/drive/v3/files/${files[0].id}?alt=media`, {
            headers: { 'Authorization': `Bearer ${googleAccessToken}` }
        }).then(response => {
            if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
            return response.json();
        }).then(data => {
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            clients = data.clients || [];
            transactions = data.transactions || [];
            
            saveData();
            updateStats();
            displayClients();
            displayTransactions();
            
            alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Drive Ø¨Ù†Ø¬Ø§Ø­');
        }).catch(error => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
            alert('âŒ ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        });
    }).catch(error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
        alert('âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù: ' + error.message);
    });
}


        // Ø±Ù…Ø² Ø§Ù„Ø§Ù…Ø§Ù†
function generateHourlyCode(secret = "ABC123") {
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDate();

    // Ù†Ø­ÙˆÙ„ ÙƒÙ„ Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¥Ù„Ù‰ Ø±Ù‚Ù… ÙˆÙ†Ø¬Ù…Ø¹Ù‡ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ÙŠÙˆÙ…
    let total = 0;
    for (let i = 0; i < secret.length; i++) {
        total += secret.charCodeAt(i) * (hour + 1) + day;
    }

    // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 6 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    const code = (total * 7).toString().slice(-6);
    return code;
}

function isAuthenticated() {
    return localStorage.getItem("authenticated") === "true";
}

function setAuthenticated() {
    localStorage.setItem("authenticated", "true");
}

function verifyLogin() {
    const code = document.getElementById("codeInput").value.trim().toUpperCase();
    const expectedCode = generateHourlyCode();

    if ( code === expectedCode) {
        setAuthenticated();
        document.getElementById("authModal").style.display = "none";
        document.getElementById("appContent").style.display = "block";
    } else {
    document.getElementById("errorMsg").innerHTML = `
        Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­. Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø·ÙˆØ±:
        <br>
        <a href="tel:+963986053607" style="display:inline-block; margin-top:10px; padding:8px 16px; background-color:#ef9a9a; color:#000; border-radius:5px; text-decoration:none;">
             Ø§ØªØµÙ„ Ø§Ù„Ø¢Ù† Ùˆ Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨ 2 Ø¯ÙˆÙ„Ø§Ø± ÙÙ‚Ø·
        </a>
    `;
}


}

window.onload = () => {
    if (isAuthenticated()) {
        document.getElementById("authModal").style.display = "none";
        document.getElementById("appContent").style.display = "block";
    }
};

//ØªØ§Ø±ÙŠØ® Ø§Ø®Ø± Ø¯ÙØ¹Ø© 
function getLastPaymentDate(clientId) {
  const payments = transactions
    .filter(t => t.clientId === clientId && t.amount < 0)
    .map(t => new Date(t.dateTime));

  if (payments.length === 0) return null;

  return payments.reduce((latest, current) => current > latest ? current : latest);
}
//ÙÙ„ØªØ±Ø© Ø§Ù„Ø§Ø³Ù…Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
function getDebtorsByPeriod(daysThreshold) {
  const now = new Date();

  return clients.filter(client => {
    if (client.currentDebt <= 0) return false;

    const lastPayment = getLastPaymentDate(client.id);
    if (!lastPayment) return true; // Ù„Ù… ÙŠØ¯ÙØ¹ Ø£Ø¨Ø¯Ù‹Ø§

    const diffDays = Math.floor((now - lastPayment) / (1000 * 60 * 60 * 24));
    return diffDays >= daysThreshold;
  });
}
document.getElementById('filterDebtorsBtn').onclick = () => {
  const days = parseInt(document.getElementById('debtPeriodSelect').value);
  const resultsDiv = document.getElementById('debtorResults');
  resultsDiv.innerHTML = '';

  const filteredClients = getDebtorsByPeriod(days);

  if (filteredClients.length === 0) {
    resultsDiv.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ·.</p>';
    return;
  }

  filteredClients.forEach(client => {
    const lastPayment = getLastPaymentDate(client.id);
    const lastDateStr = lastPayment ? lastPayment.toLocaleDateString('ar-EG') : 'Ù„Ù… ÙŠØ¯ÙØ¹ Ø£Ø¨Ø¯Ù‹Ø§';

    const item = document.createElement('div');
    item.textContent = `${client.name} - Ø¯ÙŠÙ†: ${client.currentDebt} - Ø¢Ø®Ø± Ø¯ÙØ¹Ø©: ${lastDateStr}`;
    resultsDiv.appendChild(item);
  });
};
    </script>
</body>
</html>