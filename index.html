<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
    <link rel="manifest" href="manifest.json">
    <script>
        // ØªØ­Ø¯ÙŠØ« Service Worker ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/deptappweb/service-worker.js')
              .then(function(registration) {
                console.log('ServiceWorker registered');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
                registration.addEventListener('updatefound', () => {
                  const newWorker = registration.installing;
                  console.log('New update found!');
                  
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      console.log('New content available; please refresh.');
                      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                      window.location.reload();
                    }
                  });
                });
              })
              .catch(function(error) {
                console.log('ServiceWorker registration failed: ', error);
              });
          });
        }
        </script>
    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© Google APIs Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Google Drive -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- ØªØ­Øª Ø³ÙƒØ±ÙŠØ¨Øª Google APIs -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø© Google APIs Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Google Drive -->
<script src="https://apis.google.com/js/api.js?onload=onGapiLoad"></script>
    <style>
        /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        :root {
            --primary-green: #2E8B57;
            --light-green: #E8F5E8;
            --sky-blue: #87CEEB;
            --dark-blue: #4682B4;
            --white: #FFFFFF;
            --black: #333333;
            --gray: #F5F5F5;
            --red: #FF4444;
        }

        body {
            background: var(--light-green);
            color: var(--black);
            line-height: 1.6;
        }
        

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ */
        #authModal {
            position: fixed;
            top: 0; right: 0; bottom: 0; left: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .auth-box {
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            width: 300px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .auth-box input {
            width: 90%;
            padding: 10px;
            margin: 10px 0;
            font-size: 16px;
            border: 1px solid #b2dfdb; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
            border-radius: 5px;
        }

        .auth-box button {
            padding: 10px 20px;
            font-size: 16px;
            background: #b2dfdb; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
            color: #004d40;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #errorMsg {
            color: #ef9a9a; /* Ø£Ø­Ù…Ø± ÙØ§ØªØ­ */
            margin-top: 10px;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        }

        /* ===== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ===== */
        .header {
            text-align: center;
            background: var(--primary-green);
            color: var(--white);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
        .btn {
            background: var(--sky-blue);
            color: var(--black);
            border: none;
            padding: 15px 20px;
            margin: 10px 0;
            width: 100%;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn:active {
            background: var(--dark-blue);
            transform: scale(0.98);
        }

        .btn-danger {
            background: var(--red);
            color: var(--white);
        }
        
        .btn-secondary {
            background: #CCCCCC;
            color: var(--black);
        }

        /* ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª ===== */
        .screen {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ===== */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-green);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #DDD;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--sky-blue);
            outline: none;
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* ===== Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ===== */
        .search-box {
            margin: 15px 0;
            position: relative;
        }

        .search-box input {
            padding-right: 40px;
        }

        /* ===== Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ===== */
        .list-container {
            background: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .list-item {
            padding: 15px;
            border-bottom: 1px solid #EEE;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background: var(--gray);
        }

        .client-name {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-green);
        }

        .client-debt {
            color: var(--red);
            font-weight: bold;
        }

        .transaction-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ===== */
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-buttons .btn {
            flex: 1;
        }

        /* ===== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0; 
		right: 0; 
		bottom: 0;


            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
justify-content: center;
    align-items: center;


            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;

            /* Ø§Ù„Ø­Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ */
            max-height: 80vh;       /* Ø£Ù‚ØµÙ‰ Ø§Ø±ØªÙØ§Ø¹ 80% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            overflow-y: auto;       /* ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
        }
        .close {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .results {
            margin-top: 15px;
        }



        /* ===== Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===== */
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }

        .stat-item {
            background: var(--white);
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-green);
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        /* ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© ===== */
        .bottom-tools {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 10px 15px;
            border-top: 1px solid #DDD;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .tool-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø«Ø§Ù†ÙˆÙŠØ© ØµØºÙŠØ±Ø© */
        .btn-mini {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
            background: #f0f0f0;
            color: #222;
            border: 1px solid #ddd;
            cursor: pointer;
            box-shadow: none;
            transition: background .15s, transform .08s;
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø®Ø§ØµØ© Ù„Ù„Ù€ Drive / Export */
        .btn-mini.primary { 
            background: #eef9f2; 
            color: #2E8B57; 
            border-color: #d6f0de; 
        }
        
        .btn-mini.secondary { 
            background: #ffffff; 
            color: #555; 
            border-color: #e6e6e6; 
        }
        
        .btn-mini.danger { 
            background: #fff5f5; 
            color: #c0392b; 
            border-color: #f2dede; 
        }

        .btn-mini.google { 
            background: #f1f8ff; 
            color: #1a73e8; 
            border-color: #d2e3fc; 
        }

        /* ØªØ£Ø«ÙŠØ± Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .btn-mini:hover { 
            background: #f7f7f7; 
            transform: translateY(-1px); 
        }

        /* ===== Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ===== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .btn {
                padding: 12px 15px;
                font-size: 16px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .tool-bar {
                justify-content: center;
                gap: 6px;
            }
            
            .btn-mini {
                padding: 6px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .btn-mini {
                padding: 6px 8px;
                font-size: 12px;
            }
        }
        
.contact-buttons a {
    display: block;
    margin: 10px auto;
    padding: 10px;
    background-color: #b2dfdb; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
    color: #000;
    border-radius: 5px;
    text-decoration: none;
    width: 80%;
}

.contact-buttons a:hover {
    background-color: #80cbc4;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===== */
.export-options, .import-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.option-group {
    background: var(--light-green);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
}

.option-group h3 {
    color: var(--primary-green);
    margin-bottom: 8px;
    font-size: 16px;
}

.option-group p {
    color: #666;
    font-size: 14px;
    margin-bottom: 12px;
    line-height: 1.4;
}

.option-group .btn {
    width: 100%;
    margin: 5px 0;
}

.import-status {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.import-status.success {
    background: #d1edff;
    border: 1px solid #b3d9ff;
    color: #004085;
}

.import-status.error {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

    </style>
</head>
<body>
    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ù‚Ù‚ -->
    <div id="authModal">
        <div class="auth-box">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
            <p style="margin: 10px 0; color: #666; font-size: 14px;">
                Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø·ÙˆØ±: 963986053607+
            </p>
    
            <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="codeInput" placeholder="Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px;">
                <button onclick="verifyLogin()" style="width: 100%; padding: 10px; background: #2E8B57; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
                </button>
            </div>
    
            <!-- ÙØ§ØµÙ„ -->
            <div style="text-align: center; margin: 15px 0; color: #888;">
                â”€â”€â”€ Ø£Ùˆ â”€â”€â”€
            </div>
    
            <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google -->
            <button class="btn-mini google" id="googleAuthBtn" onclick="showRefreshMessage()">
                Ù„Ø¯ÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ 
            </button>
            <p id="refreshMessage" style="text-align: center; margin: 15px 0; color: #690909; display: none;">
                Ø­Ø¯Ø« Ø§Ù„ØµÙØ­Ø© Ø§Ùˆ Ù‚Ù… Ø¨Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø­ØªÙ‰ ÙŠÙØªØ­ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø­Ø³Ø§Ø¨Ùƒ
            </p>
            <div id="errorMsg" style="margin-top: 15px; min-height: 40px;"></div>
        </div>
    </div>
    <!-- ===== Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== -->
    <div class="container">
        
        <!-- ===== Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== -->
        <div id="mainScreen" class="screen active">
            <div class="header">
                <h1>Ù„Ø§ ØªÙ†Ø³ÙˆØ§ Ø¹Ù…Ù„ ØªØµØ¯ÙŠØ± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª </h1>
                <button onclick="showInfoModal()" id = "versionButton" style="color: #004d40; font-family: 'Courier New', Courier, monospace; background-color: #80cbc4;" >v2.3.0</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalDebt">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©</div>
                </div>
            </div>

            <button class="btn" onclick="showScreen('addClientScreen')">Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</button>
            <button class="btn" onclick="showScreen('addTransactionScreen')">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="btn" onclick="showScreen('clientsScreen')">Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
            <button class="btn" onclick="showScreen('transactionsScreen')">Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            <button id="showOldDebtsBtn" class="btn btn-warning">Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ø°ÙŠÙ† ØªØ£Ø®Ø±ÙˆØ§ ÙÙŠ Ø§Ù„Ø¯ÙØ¹</button>
            
               
               <!-- ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© ===== -->
            <div class="tool-bar" id="utilityToolbar">
                <!-- Ø£Ø²Ø±Ø§Ø± Ø±Ø¦ÙŠØ³ÙŠØ© -->
                <button class="btn-mini primary" onclick="openExportModal()">
                    ğŸ“¤ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                
                <button class="btn-mini secondary" onclick="openImportModal()">
                    ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
                
                <!-- Ø£Ø²Ø±Ø§Ø± Google - ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ -->
                <button class="btn-mini google" id="googleAuthBtn" onclick="handleGoogleAuth()">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google
                </button>
                
                <button class="btn-mini danger" id="logoutBtn" onclick="handleGoogleLogout()" style="display:none;">
                    ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>

        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† ===== -->
        <div id="addClientScreen" class="screen">
            <div class="header">
                <h1>Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h1>
            </div>

            <div class="form-group">
                <label for="clientName">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:</label>
                <input type="text" id="clientName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
            </div>

            <button class="btn" onclick="addClient()">Ø­ÙØ¸ Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ===== -->
        <div id="addTransactionScreen" class="screen">
            <div class="header">
                <h1>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            </div>

            <div class="form-group">
                <label for="transactionClientInput">Ø§Ø®ØªØ± Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‡:</label>
                <input type="text" id="transactionClientInput" class="form-control" autocomplete="off" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø§Ø®ØªØ± ÙˆØ§Ø­Ø¯">
                <input type="hidden" id="transactionClientId">
                <div id="transactionSuggestions" class="list-container" style="display:none; position:relative; max-height:200px; overflow:auto;"></div>
            </div>
            
            <div class="form-group">
                <label for="isPayment">Ø¯ÙØ¹:</label>
                <input type="checkbox" id="isPayment">
            </div>
            
            <div class="form-group">
                <label for="transactionAmount">Ø§Ù„Ù…Ø¨Ù„Øº :</label>
                <input type="number" id="transactionAmount" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº">
            </div>

            <div class="form-group">
                <label for="transactionNotes">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</label>
                <textarea id="transactionNotes" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"></textarea>
            </div>

            <button class="btn" onclick="addTransaction()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ===== -->
        <div id="clientsScreen" class="screen">
            <div class="header">
                <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h1>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

            <div class="search-box">
                <input type="text" id="searchClient" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø²Ø¨ÙˆÙ†...">
            </div>

            <div id="clientsList" class="list-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† -->
            </div>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ===== -->
        <div id="transactionsScreen" class="screen">
            <div class="header">
                <h1>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('mainScreen')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            
            <div class="search-box">
                <input type="text" id="searchTransaction" class="form-control" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...">
            </div>

            <div id="transactionsList" class="list-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
            </div>
        </div>

        <!-- ===== Ø´Ø§Ø´Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯ ===== -->
        <div id="clientTransactionsScreen" class="screen">
            <div class="header">
                <h1 id="clientTransactionsTitle">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†</h1>
            </div>

            <div class="list-container">
                <div class="client-info">
                    <div class="client-name" id="currentClientName"></div>
                    <div class="client-debt" id="currentClientDebt"></div>
                    <button class="btn" onclick="showEditClientName()">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</button>
                    <button class="btn" onclick="startTransactionForCurrentClient()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
            </div>

            <div id="clientTransactionsList" class="list-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø¨ÙˆÙ† -->
            </div>

            <button id="back" class="btn btn-secondary" onclick="showScreen('clientsScreen')">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
        </div>
    </div>

    <!-- ===== Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ===== -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 style="color: var(--primary-green); margin-bottom: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h2>
            
            <div class="form-group">
                <label for="editAmount">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
                <input type="number" id="editAmount" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="editisPayment">Ø¯ÙØ¹:</label>
                <input type="checkbox" id="editisPayment">
            </div>
            
            <div class="form-group">
                <label for="editNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                <textarea id="editNotes" class="form-control"></textarea>
            </div>

            <div class="nav-buttons">
                <button class="btn" onclick="updateTransaction()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- ===== Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† ===== -->
    <div id="editClientNameModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditClientNameModal()">&times;</span>
            <h2 style="color: var(--primary-green); margin-bottom: 20px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</h2>
    
            <div class="form-group">
                <label for="editClientName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                <input type="text" id="editClientName" class="form-control">
            </div>
    
            <div class="nav-buttons">
                <button class="btn" onclick="updateClientName()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                <button class="btn btn-secondary" onclick="closeEditClientNameModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInfoModal()">Ã—</span>
            <h2>Ø­ÙˆÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h2>
            <p>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ† Ù‡Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ù…Ù† ØªØ·ÙˆÙŠØ± ÙŠÙˆÙ†Ø³ Ø®ÙŠØ²Ø±Ø§Ù† . <br> Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.3.0<br>*ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ù…Ù†ÙŠØ© Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø³ØªÙ‚Ø± Ø§ÙƒØ«Ø± <br>*Ø§ØªØµØ§Ù„ Ù…Ø³ØªÙ‚Ø± Ù…Ø¹ ØºÙˆØºÙ„ <br>*ØªØµØ¯ÙŠØ± Ùˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥Ù„Ù‰ ØºÙˆØºÙ„ Ø¯Ø±Ø§ÙŠÙ <br>*ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†ÙØ³Ù‡ Ø¹Ù„Ù‰ Ø§ÙƒØ«Ø± Ù…Ù† Ø¬Ù‡Ø§Ø² </p>
            <div class="stats">
                <a  href="https://www.facebook.com/younismkh" target="_blank"><button class="btn-danger"><img src="icons/fb.png" alt="facebook"></button></a>

                <a href="mailto:khezaranyounis@outlook.com?subject=Ø·Ù„Ø¨ Ø¯Ø¹Ù…&body= Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£ÙˆØ§Ø¬Ù‡ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ 2.3.0..." ><button class="btn-mini">Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¯Ø¹Ù… Ùˆ Ø§Ù„Ø´ÙƒÙˆÙ‰</button></a>
                
                <a  href="https://www.youtube.com/@youniskhezaran9863" target="_blank"><button class="btn-danger"><img src="icons/yb.png" alt="youtube"></button></a>
            </div>
        </div>
    </div>

    <div id="oldDebtsModal" class="modal" style="display:none;">
        <div class="modal-content">
          <span id="closeOldDebtsModal" class="close">&times;</span>
          <h3>Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</h3>
          <select id="debtPeriodSelect">
            <option value="30">Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±</option>
            <option value="60">Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±ÙŠÙ†</option>
            <option value="90">Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø£Ø´Ù‡Ø±</option>
            <option value="180">Ø£ÙƒØ«Ø± Ù…Ù† 6 Ø£Ø´Ù‡Ø±</option>
            <option value="365">Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ù†Ø©</option>
          </select>
          <button id="filterDebtorsBtn" class="btn btn-primary">Ø¹Ø±Ø¶ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</button>
          <div id="debtorResults" class="results"></div>
        </div>
      </div>
            <!-- ===== Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØµØ¯ÙŠØ± ===== -->
        <div id="exportModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeExportModal()">&times;</span>
                <h2 style="color: var(--primary-green); margin-bottom: 20px;">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±</h2>
                
                <div class="export-options">
                    <div class="option-group">
                        <h3>ğŸ“ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ù…Ù„Ù</h3>
                        <p>Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„Ù JSON</p>
                        <button class="btn btn-primary" onclick="exportDataToFile()">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ù…Ù„Ù JSON</button>
                    </div>
                    
                    <div class="option-group">
                        <h3>â˜ï¸ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</h3>
                        <p>Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Drive (ÙŠØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)</p>
                        <button class="btn btn-primary" id="exportToDriveBtn" onclick="syncWithDrive()">Ø±ÙØ¹ Ø¥Ù„Ù‰ Google Drive</button>
                        <div id="driveExportStatus" style="margin-top: 10px; font-size: 14px;"></div>
                    </div>
                    
                    <div class="option-group">
                        <h3>ğŸ“‹ Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©</h3>
                        <p>Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ†Øµ ÙŠÙ…ÙƒÙ† Ù„ØµÙ‚Ù‡ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†</p>
                        <button class="btn btn-secondary" onclick="copyToClipboard()">Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ©</button>
                    </div>
                    <div class="option-group">
                        <h3>Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
                        <p>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ®Ø²Ù† Ø¶Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø§Ø®Ø±Ù‰ Ø±Ø¨Ù…Ø§ ØªÙ†ÙØ¹ ÙÙŠ Ø­Ø§Ù„ ØµØ§Ø± Ù†Ù‚Øµ</p>
                    <button onclick="saveToLocalStorage()" class="btn btn-secondary">Ø­ÙØ¸ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
                    </div>
                
                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="closeExportModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>

        <!-- ===== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ===== -->
        <div id="importModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeImportModal()">&times;</span>
                <h2 style="color: var(--primary-green); margin-bottom: 20px;">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h2>
                
                <div class="import-options">
                    
                    
                    <div class="option-group">
                        <h3>ğŸ”„ Ø¯Ù…Ø¬ Ù…Ù„ÙØ§Øª</h3>
                        <p>Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù JSON Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
                        <input type="file" id="mergeFileInput" accept=".json" style="display:none;">
                        <input type="file" id="importFile" accept=".json" style="display:none;">
                        <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                            Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù
                        </button>
		<button class="btn btn-secondary" id="mergeFileBtn">Ø¯Ù…Ø¬ Ù…Ù„Ù JSON</button>
                
                    </div>
                    
                    <div class="option-group">
                        <h3>â˜ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©</h3>
                        <p>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive (ÙŠØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)</p>
                        <button class="btn btn-primary" id="importFromDriveBtn" onclick="importFromDrive()">
                            Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Google Drive
                        </button>
                        <div id="driveImportStatus" style="margin-top: 10px; font-size: 14px;"></div>
                    </div>
                    
                    <div class="option-group">
                        <h3>ğŸ’¾ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h3>
                        <p>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</p>
                        <button class="btn btn-secondary" onclick="restoreFromBackup()">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                    </div>
                </div>
                
                <div class="import-status" id="importStatus" style="margin-top: 20px; padding: 10px; border-radius: 5px; display: none;"></div>
                
                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="closeImportModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    <script>
        // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
        let clients = JSON.parse(localStorage.getItem('debtClients')) || [];
        let transactions = JSON.parse(localStorage.getItem('debtTransactions')) || [];
        let currentClientId = null;
        let currentTransactionId = null;
        let isGoogleAuthenticated = false;
        let googleAccessToken = null;
        // ===== ØªÙ‡ÙŠØ¦Ø© Google APIs =====
function initGapi() {
    return new Promise((resolve, reject) => {
        if (typeof gapi !== 'undefined' && gapi.client) {
            resolve();
            return;
        }
        
        gapi.load('client', {
            callback: function() {
                gapi.client.init({
                    apiKey: '',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                }).then(() => {
                    console.log('âœ… GAPI client initialized');
                    resolve();
                }).catch(reject);
            },
            onerror: function() {
                reject(new Error('Failed to load GAPI client'));
            },
            timeout: 5000,
            ontimeout: function() {
                reject(new Error('Timeout loading GAPI client'));
            }
        });
    });
}
        // ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    
    // Ø£ÙˆÙ„Ø§Ù‹: ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    loadAuthState();
    
    // Ø«Ù…: ØªÙ‡ÙŠØ¦Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    updateStats();
    loadClientsForTransaction();
    displayClients();
    displayTransactions();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø¨Ø­Ø«
    document.getElementById('searchClient').addEventListener('input', filterClients);
    document.getElementById('searchTransaction').addEventListener('input', filterTransactions);
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Google Drive
    setupGoogleDriveButtons();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª
    setupFileButtons();
    
    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„');
});
        document.getElementById('showOldDebtsBtn').onclick = () => {
            document.getElementById('oldDebtsModal').style.display = 'block';
            };
            //
            
        document.getElementById('closeOldDebtsModal').onclick = () => {
            document.getElementById('oldDebtsModal').style.display = 'none';
            };
            //
   function showInfoModal() {
    const modal = document.getElementById("infoModal");
    if (modal) {
      modal.style.display = "block";
    }
  }

  function closeInfoModal() {
    const modal = document.getElementById("infoModal");
    if (modal) {
      modal.style.display = "none";
    }
  }
// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =====
function openExportModal() {
    document.getElementById('exportModal').style.display = 'block';
    updateExportButtons();
}

function closeExportModal() {
    document.getElementById('exportModal').style.display = 'none';
}

function openImportModal() {
    document.getElementById('importModal').style.display = 'block';
    updateImportButtons();
}

function closeImportModal() {
    document.getElementById('importModal').style.display = 'none';
}
function showRefreshMessage() {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    const messageElement = document.getElementById('refreshMessage');
    if (messageElement) {
        messageElement.style.display = 'block';
    }

    // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    handleGoogleAuth();
}
// ===== ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateExportButtons() {
    const exportToDriveBtn = document.getElementById('exportToDriveBtn');
    const driveExportStatus = document.getElementById('driveExportStatus');
    
    if (isGoogleAuthenticated) {
        exportToDriveBtn.disabled = false;
        exportToDriveBtn.innerHTML = 'ğŸ”¼ Ø±ÙØ¹ Ø¥Ù„Ù‰ Google Drive';
        driveExportStatus.innerHTML = '<span style="color: green;">âœ“ Ù…ØªØµÙ„ Ø¨Ù€ Google Drive</span>';
    } else {
        exportToDriveBtn.disabled = true;
        exportToDriveBtn.innerHTML = 'ğŸ”’ ÙŠÙ„Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        driveExportStatus.innerHTML = '<span style="color: orange;">âš ï¸ ÙŠÙ„Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Drive</span>';
    }
}

// ===== ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function updateImportButtons() {
    const importFromDriveBtn = document.getElementById('importFromDriveBtn');
    const driveImportStatus = document.getElementById('driveImportStatus');
    
    if (isGoogleAuthenticated) {
        importFromDriveBtn.disabled = false;
        importFromDriveBtn.innerHTML = 'ğŸ”½ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Google Drive';
        driveImportStatus.innerHTML = '<span style="color: green;">âœ“ Ù…ØªØµÙ„ Ø¨Ù€ Google Drive</span>';
    } else {
        importFromDriveBtn.disabled = true;
        importFromDriveBtn.innerHTML = 'ğŸ”’ ÙŠÙ„Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        driveImportStatus.innerHTML = '<span style="color: orange;">âš ï¸ ÙŠÙ„Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Drive</span>';
    }
}

  window.onload = () => {
    const versionBtn = document.getElementById("versionButton");
    const closeBtn = document.getElementById("closeInfoModal");

    if (versionBtn) {
      versionBtn.onclick = showInfoModal;
    }

    if (closeBtn) {
      closeBtn.onclick = closeInfoModal;
    }
  };


        
        // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø§Øª =====
        function showScreen(screenId) {
            // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });

            // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.style.display = 'block';
            }

            // ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ø®Ø±Ø¬Ù†Ø§ Ù…Ù†Ù‡Ø§
            if (screenId !== 'clientTransactionsScreen') {
                clearClientTransactionsScreen();
            }

            if (screenId === 'clientsScreen') {
                displayClients();
            } else if (screenId === 'transactionsScreen') {
                displayTransactions();
            } else if (screenId === 'addTransactionScreen') {
                loadClientsForTransaction();
            }
        }

        function clearClientTransactionsScreen() {
            document.getElementById('currentClientName').textContent = '';
            document.getElementById('currentClientDebt').textContent = '';
            document.getElementById('clientTransactionsTitle').textContent = 'Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø¨ÙˆÙ†';
            document.getElementById('clientTransactionsList').innerHTML = '';
            currentClientId = null;
        }

        // ===== Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯ =====
        function addClient() {
            const nameInput = document.getElementById('clientName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†');
                return;
            }
            
            const newClient = {
                id: Date.now(),
                name: name,
                currentDebt: 0
            };
            
            clients.push(newClient);
            saveData();
            nameInput.value = '';
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø¨ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­');
            showScreen('mainScreen');
            updateStats();
        }

        // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© =====
        function loadClientsForTransaction(selectedClientId = null) {
            const input = document.getElementById('transactionClientInput');
            const suggestions = document.getElementById('transactionSuggestions');
            input.value = '';
            document.getElementById('transactionClientId').value = '';

            // Ø¨Ù†Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
            suggestions.innerHTML = '';
            clients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.style.cursor = 'pointer';
                item.textContent = `${client.name} (Ø¯ÙŠÙ† Ø­Ø§Ù„Ù‰: ${client.currentDebt})`;
                item.dataset.clientId = client.id;
                item.addEventListener('click', () => {
                    input.value = client.name;
                    document.getElementById('transactionClientId').value = client.id;
                    suggestions.style.display = 'none';
                });
                suggestions.appendChild(item);
            });

            // Ù„Ùˆ Ù…Ø±Ø±Ù†Ø§ selectedClientId Ù…Ù† startTransactionForCurrentClient
            if (selectedClientId) {
                const client = clients.find(c => c.id === selectedClientId);
                if (client) {
                    input.value = client.name;
                    document.getElementById('transactionClientId').value = client.id;
                }
            }
        }

        // ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© =====
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('transactionClientInput');
            const suggestions = document.getElementById('transactionSuggestions');

            // Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒØ§Ù…Ù„Ø©
            input.addEventListener('focus', () => {
                if (suggestions.children.length) suggestions.style.display = 'block';
            });

            // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ
            input.addEventListener('input', () => {
                const q = input.value.trim().toLowerCase();
                let anyVisible = false;
                Array.from(suggestions.children).forEach(item => {
                    const name = item.textContent.toLowerCase();
                    if (!q || name.includes(q)) {
                        item.style.display = 'block';
                        anyVisible = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                suggestions.style.display = anyVisible ? 'block' : 'none';
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ø°Ø§ ØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Øµ ÙŠØ¯ÙˆÙŠØ§Ù‹
                if (!q) {
                    document.getElementById('transactionClientId').value = '';
                } else {
                    const exact = clients.find(c => c.name.toLowerCase() === q);
                    document.getElementById('transactionClientId').value = exact ? exact.id : '';
                }
            });

            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#transactionSuggestions') && !e.target.closest('#transactionClientInput')) {
                    suggestions.style.display = 'none';
                }
            });
        });

        // ===== Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© =====
        function addTransaction() {
            const clientIdHidden = document.getElementById('transactionClientId').value;
            const clientId = parseInt(clientIdHidden, 10);
            const amountInput = document.getElementById('transactionAmount');
            const notesInput = document.getElementById('transactionNotes');
            const isPaymentCheckbox = document.getElementById('isPayment');

            let amount = parseFloat(amountInput.value);
            let NotesIfPay="";
            
            const notes = notesInput.value.trim();
            const isPayment = isPaymentCheckbox.checked;
            NotesIfPay = isPayment ? "....Ø¯ÙØ¹ ...."+notes : notes
            if (!clientId || isNaN(amount) || NotesIfPay=="") {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø²Ø¨ÙˆÙ† ØµØ§Ù„Ø­ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                return;
            }

            amount = isPayment ? -Math.abs(amount) : Math.abs(amount);

            const newTransaction = {
                id: Date.now(),
                clientId: clientId,
                amount: amount,
                notes: NotesIfPay,
                dateTime: new Date().toLocaleString('ar-EG')
            };

            transactions.push(newTransaction);

            const client = clients.find(c => c.id === clientId);
            if (client) client.currentDebt += amount;

            saveData();

            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('transactionClientInput').value = '';
            document.getElementById('transactionClientId').value = '';
            amountInput.value = '';
            notesInput.value = '';
            isPaymentCheckbox.checked = false;

            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
            showScreen('mainScreen');
            updateStats();
        }

        // ===== Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† =====
        function displayClients() {
            document.getElementById('back').style.display = 'none';
            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = '';
            
            clients.forEach(client => {
                const clientItem = document.createElement('div');
                clientItem.className = 'list-item';
                clientItem.innerHTML = `
                    <div class="client-name">${client.name}</div>
                    <div class="client-debt">Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: ${client.currentDebt}</div>
                `;
                clientItem.onclick = () => showClientTransactions(client.id);
                clientsList.appendChild(clientItem);
            });
        }

        // ===== Ø¹Ø±Ø¶ Ø¹Ù…Ù„ÙŠØ§Øª Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯ =====
        function showClientTransactions(clientId) {
            document.getElementById('back').style.display = 'inline-block';
            currentClientId = clientId;
            const client = clients.find(c => c.id === clientId);
            
            if (client) {
                document.getElementById('currentClientName').textContent = client.name;
                document.getElementById('currentClientDebt').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙ†: ${client.currentDebt}`;
                document.getElementById('clientTransactionsTitle').textContent = `Ø¹Ù…Ù„ÙŠØ§Øª ${client.name}`;
            }
            
            const transactionsList = document.getElementById('clientTransactionsList');
            transactionsList.innerHTML = '';
            
            const clientTransactions = transactions.filter(t => t.clientId === clientId);
            
            clientTransactions.slice().reverse().forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'list-item';
                transactionItem.innerHTML = `
                    <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${transaction.amount}</div>
                    <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${transaction.dateTime}</div>
                    <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${transaction.notes}</div>
                `;
                transactionItem.onclick = () => editTransaction(transaction.id);
                transactionsList.appendChild(transactionItem);
            });
            
            showScreen('clientTransactionsScreen');
        }

        // ===== Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª =====
        function displayTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = '';
            
            transactions.slice().reverse().forEach(transaction => {
                const client = clients.find(c => c.id === transaction.clientId);
                const clientName = client ? client.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                
                const transactionItem = document.createElement('div');
                transactionItem.className = 'list-item';
                transactionItem.innerHTML = `
                    <div><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> ${clientName}</div>
                    <div><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${transaction.amount}</div>
                    <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${transaction.dateTime}</div>
                    <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${transaction.notes.substring(0, 50)}${transaction.notes.length > 50 ? '...' : ''}</div>
                `;
                transactionItem.onclick = () => editTransaction(transaction.id);
                transactionsList.appendChild(transactionItem);
            });
        }

        // ===== ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© =====
        function editTransaction(transactionId) {
            currentTransactionId = transactionId;
            const transaction = transactions.find(t => t.id === transactionId);

            if (transaction) {
                // Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ù…Ø®Ø²Ù†Ù†Ø§ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø³Ø§Ù„Ø¨ Ù„Ù„Ø¯ÙØ¹ØŒ Ù„ÙƒÙ† Ù†Ø¹Ø±Ø¶Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¹ ØªØ¹ÙŠÙŠÙ† checkbox
                document.getElementById('editAmount').value = Math.abs(transaction.amount);
                document.getElementById('editNotes').value = transaction.notes;

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø³Ø§Ù„Ø¨Ø§Ù‹ ÙÙ‡Ùˆ Ø¯ÙØ¹Ø© => checkbox Ù…ÙØ¹Ù„
                document.getElementById('editisPayment').checked = transaction.amount < 0;

                // Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                document.getElementById('editTransactionModal').style.display = 'block';
            }
        }

        // ===== ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ù„Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯ =====
        function startTransactionForCurrentClient() {
            if (!currentClientId) {
                alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨ÙˆÙ† Ù…Ø­Ø¯Ø¯');
                return;
            }
            loadClientsForTransaction(currentClientId); // Ø³ÙŠÙ…Ù„Ø£ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„Ø²Ø¨ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ
            showScreen('addTransactionScreen');
            // ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¨Ù„Øº
            setTimeout(() => document.getElementById('transactionAmount').focus(), 100);
        }

        // ===== Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… =====
        function showEditClientName() {
            const client = clients.find(c => c.id === currentClientId);
            if (client) {
                document.getElementById('editClientName').value = client.name;
                document.getElementById('editClientNameModal').style.display = 'block';
            }
        }

        function closeEditClientNameModal() {
            document.getElementById('editClientNameModal').style.display = 'none';
        } 
        
        function updateClientName() {
            const newName = document.getElementById('editClientName').value.trim();
            if (!newName) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ§Ù„Ø­');
                return;
            }

            const client = clients.find(c => c.id === currentClientId);
            if (client) {
                client.name = newName;
                saveData();
                closeEditClientNameModal();
                alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');
                showClientTransactions(currentClientId); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                updateStats();
            }
        }

        // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ© =====
        function updateTransaction() {
            const amountInput = document.getElementById('editAmount');
            const notesInput = document.getElementById('editNotes');
            const isPaymentCheckbox = document.getElementById('editisPayment');

            const rawAmount = parseFloat(amountInput.value);
            const notes = notesInput.value.trim();
            const isPayment = isPaymentCheckbox.checked;

            if (isNaN(rawAmount) || !notes) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
                return;
            }

            const updatedAmount = isPayment ? -Math.abs(rawAmount) : Math.abs(rawAmount);

            const transactionIndex = transactions.findIndex(t => t.id === currentTransactionId);
            if (transactionIndex !== -1) {
                const oldAmount = transactions[transactionIndex].amount;
                transactions[transactionIndex].amount = updatedAmount;
                transactions[transactionIndex].notes = notes;

                const client = clients.find(c => c.id === transactions[transactionIndex].clientId);
                if (client) {
                    // Ù†Ø¶ÙŠÙ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                    client.currentDebt += (updatedAmount - oldAmount);
                }

                saveData();
                closeModal();
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');

                if (currentClientId) {
                    showClientTransactions(currentClientId);
                } else {
                    displayTransactions();
                }
                updateStats();
            }
        }

        // ===== Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =====
        function closeModal() {
            document.getElementById('editTransactionModal').style.display = 'none';
        }

        // ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† =====
        function filterClients() {
            const searchText = document.getElementById('searchClient').value.toLowerCase();
            const clientItems = document.querySelectorAll('#clientsList .list-item');
            
            clientItems.forEach(item => {
                const clientName = item.querySelector('.client-name').textContent.toLowerCase();
                if (clientName.includes(searchText)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ===== ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª =====
        function filterTransactions() {
            const searchText = document.getElementById('searchTransaction').value.toLowerCase();
            const transactionItems = document.querySelectorAll('#transactionsList .list-item');
            
            transactionItems.forEach(item => {
                const itemText = item.textContent.toLowerCase();
                if (itemText.includes(searchText)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ===== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª =====
        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            
            const totalDebt = clients.reduce((sum, client) => sum + client.currentDebt, 0);
            document.getElementById('totalDebt').textContent = totalDebt.toFixed(2);
        }

        // ===== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage =====
        function saveData() {
            localStorage.setItem('debtClients', JSON.stringify(clients));
            localStorage.setItem('debtTransactions', JSON.stringify(transactions));
        }

        // ===== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ =====
        function closeApp() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
                // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ø¹Ø§Ø¯ÙŠ
                window.close();
                // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­ÙˆÙ„ Ø¥Ù„Ù‰ APKØŒ Ù‡Ø°Ø§ Ø³ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¦Ø©
            }
        }

        // ===== Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©æ„å¤–ÙŠ =====
        window.addEventListener('beforeunload', function (e) {
            e.preventDefault();
            e.returnValue = '';
        });

        // ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„ÙØ§Øª =====
        function setupFileButtons() {
            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¯Ù…Ø¬ Ù…Ù„Ù JSON
            document.getElementById('mergeFileBtn').addEventListener('click', async () => {
                const input = document.getElementById('importFile');
                if (!input.files || !input.files[0]) return alert('Ø§Ø®ØªØ± Ù…Ù„Ù JSON Ø£ÙˆÙ„Ø§Ù‹');
                try {
                    const text = await input.files[0].text();
                    const parsed = JSON.parse(text);

                    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
                    const incomingClients = Array.isArray(parsed.clients) ? parsed.clients : [];
                    const incomingTransactions = Array.isArray(parsed.transactions) ? parsed.transactions : [];

                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: Ø¥Ø°Ø§ ÙƒØ§Ù† id Ù…ØªØ·Ø§Ø¨Ù‚ Ù„Ø§ ØªØ¶ÙŠÙØŒ Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙŠÙ…ÙƒÙ† Ø¶Ø¨Ø· Ø°Ù„Ùƒ Ù‡Ù†Ø§
                    const existingClientIds = new Set(clients.map(c => c.id));
                    incomingClients.forEach(ic => {
                        if (!existingClientIds.has(ic.id)) {
                            clients.push(ic);
                        } else {
                            // Ù…Ø«Ø§Ù„: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¯ÙŠÙ† Ø¥Ù† Ø±ØºØ¨Øª (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                            const existing = clients.find(c => c.id === ic.id);
                            if (existing) {
                                // Ø®ÙŠØ§Ø± 1: Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¡ (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù…Ù„Ù) â€” Ø§ÙØ¹Ù„ nothing
                                // Ø®ÙŠØ§Ø± 2: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ù…Ù„Ù:
                                // existing.name = ic.name;
                                // existing.currentDebt = ic.currentDebt;
                            }
                        }
                    });

                    // Ø¯Ù…Ø¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­Ø³Ø¨ id
                    const existingTxnIds = new Set(transactions.map(t => t.id));
                    incomingTransactions.forEach(it => {
                        if (!existingTxnIds.has(it.id)) {
                            transactions.push(it);
                        }
                    });

                    // Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ù…Ø¬: Ø­ÙØ¸ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    saveData();
                    updateStats();
                    displayClients();
                    displayTransactions();
                    alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                } catch (e) {
                    console.error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', e);
                    alert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø£Ùˆ ØªÙ†Ø³ÙŠÙ‚Ù‡ ØºÙŠØ± ØµØ­ÙŠØ­ JSON');
                }
            });

            // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„Ù JSON
            document.getElementById('exportFileBtn').addEventListener('click', () => {
                exportDataToFile();
            });
        }

        // ===== ØªÙˆÙ„ÙŠØ¯ Ø§Ø³Ù… Ù…Ù„Ù Ù…Ø¹ Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ =====
        function makeBackupFilename() {
            const now = new Date();
            const ts = now.toISOString().replace(/[:.]/g, '-'); // ØµØ§Ù„Ø­ ÙƒØ§Ø³Ù… Ù…Ù„Ù
            return `debt_backup_${ts}.json`;
        }

        // ===== Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙƒÙ…Ù„Ù JSON ÙˆØªÙ†Ø²ÙŠÙ„Ù‡ =====
        // ===== Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ APK =====
function exportDataToFile(filename = null) {
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        exportedAt: new Date().toISOString()
    };

    const jsonString = JSON.stringify(data, null, 2);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ù„Ù„Ù…ØªØµÙØ­Ø§Øª)
    try {
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename || makeBackupFilename();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (e) {
        console.log('Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙØ´Ù„ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
    }
    
    // Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù„Ù€ APK
    
}
function copyToClipboard() {
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        exportedAt: new Date().toISOString()
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    
    navigator.clipboard.writeText(jsonString).then(() => {
        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©\nÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù…Ù„Ø§Ø­Ø¸Ø§Øª');
        document.querySelector('div').remove();
    }).catch(() => {
        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„Ù†Ø³Ø®
        const textArea = document.createElement('textarea');
        textArea.value = jsonString;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
        document.querySelector('div').remove();
    });
}

function openInNewTab(url) {
    const newWindow = window.open(url, '_blank');
    if (newWindow) {
        alert('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©\nÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¯ÙˆÙŠØ§Ù‹');
    }
    document.querySelector('div').remove();
}

function saveToLocalStorage() {
    const data = {
        clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
        transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
        backupDate: new Date().toLocaleString('ar-EG')
    };
    
    localStorage.setItem('debtManualBackup', JSON.stringify(data));
    localStorage.setItem('lastBackupTime', new Date().toISOString());
    
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹');
    document.querySelector('div').remove();
}

// ===== Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© =====
function restoreFromBackup() {
    const backup = localStorage.getItem('debtManualBackup');
    if (!backup) {
        alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©');
        return;
    }
    
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')) {
        try {
            const data = JSON.parse(backup);
            clients = data.clients || [];
            transactions = data.transactions || [];
            saveData();
            updateStats();
            displayClients();
            displayTransactions();
            alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            alert('âŒ ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
        }
    }
}

        // ===== ÙˆØ¸Ø§Ø¦Ù Google Drive =====
        // ===== Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Google Drive Ù…Ø¹ ØªØªØ¨Ø¹ =====
function setupGoogleDriveButtons() {
    console.log('ğŸ”§ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Google Drive...');
    
    const authBtn = document.getElementById('googleAuthBtn');
    const syncBtn = document.getElementById('syncDriveBtn');
    const importBtn = document.getElementById('importDriveBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (authBtn) {
        authBtn.addEventListener('click', handleGoogleAuth);
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    }
    
    if (syncBtn) {
        syncBtn.addEventListener('click', syncWithDrive);
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
    }
    
    if (importBtn) {
        importBtn.addEventListener('click', importFromDrive);
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
    }
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleGoogleLogout);
        console.log('âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
    }
}

        // ===== Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Google =====
        // ===== Ù…ØµØ§Ø¯Ù‚Ø© Google - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù† =====
        // ===== Ù…ØµØ§Ø¯Ù‚Ø© Google - Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø³Ù† =====
// ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OAuth =====
const CLIENT_ID = '818632760933-3j6rmg7vui3epuc15nejm7od6mbb37km.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// ===== Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function saveAuthState(tokenResponse) {
    const authState = {
        accessToken: tokenResponse.access_token,
        expiresAt: Date.now() + (tokenResponse.expires_in * 1000),
        scope: tokenResponse.scope,
        tokenType: tokenResponse.token_type
    };
    
    localStorage.setItem('googleAuth', JSON.stringify(authState));
    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©');
}


// ===== Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ† =====
async function testTokenValidity() {
    if (!isGoogleAuthenticated || !googleAccessToken) {
        console.log('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ† - ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡');
        return;
    }
    
    try {
        console.log('ğŸ§ª Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ†...');
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Drive API
        await initGapi();
        gapi.client.setToken({ access_token: googleAccessToken });
        
        const response = await gapi.client.drive.about.get({
            fields: 'user'
        });
        
        console.log('âœ… Ø§Ù„ØªÙˆÙƒÙ† ØµØ§Ù„Ø­ - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', response.result.user.displayName);
        return true;
        
    } catch (error) {
        console.error('âŒ Ø§Ù„ØªÙˆÙƒÙ† ØºÙŠØ± ØµØ§Ù„Ø­:', error);
        
        if (error.status === 401) {
            console.log('ğŸ” Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...');
            clearAuthState();
        }
        return false;
    }
}
// ===== ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù† =====
function loadAuthState() {
    console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø­ÙÙˆØ¸Ø©...');
    
    try {
        const saved = localStorage.getItem('googleAuth');
        console.log('ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†:', saved ? 'Ù…ÙˆØ¬ÙˆØ¯Ø©' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        
        if (saved) {
            const authState = JSON.parse(saved);
            const now = Date.now();
            
            console.log('â° ÙˆÙ‚Øª Ø§Ù„Ø¢Ù†:', new Date(now).toLocaleString('ar-EG'));
            console.log('â° ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', new Date(authState.expiresAt).toLocaleString('ar-EG'));
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù… ÙŠÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØªÙ‡
            if (now < authState.expiresAt) {
                googleAccessToken = authState.accessToken;
                isGoogleAuthenticated = true;
                
                updateAuthUI();
                console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§');
                console.log('ğŸ”‘ Ø§Ù„ØªÙˆÙƒÙ†:', googleAccessToken ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                
                // Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ØªÙˆÙƒÙ†
                testTokenValidity();
                return true;
            } else {
                console.log('âš ï¸ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ† - ØªÙ… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù†Ø°:', Math.round((now - authState.expiresAt) / 1000 / 60), 'Ø¯Ù‚ÙŠÙ‚Ø©');
                clearAuthState();
            }
        } else {
            console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø­ÙÙˆØ¸Ø©');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
        clearAuthState();
    }
    return false;
}

// ===== ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
// ===== ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù† =====
function updateAuthUI() {
    console.log('ğŸ¨ ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', isGoogleAuthenticated);
    
    const authBtn = document.getElementById('googleAuthBtn');
    const syncBtn = document.getElementById('syncDriveBtn');
    const importBtn = document.getElementById('importDriveBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    
    if (isGoogleAuthenticated) {
        console.log('ğŸ‘¤ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        
        if (authBtn) authBtn.style.display = 'none';
        if (syncBtn) syncBtn.style.display = 'inline-block';
        if (importBtn) importBtn.style.display = 'inline-block';
        if (logoutBtn) logoutBtn.style.display = 'inline-block';
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        addUserInfoToUI();
        
    } else {
        console.log('ğŸ‘¤ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„');
        
        if (authBtn) authBtn.style.display = 'inline-block';
        if (syncBtn) syncBtn.style.display = 'none';
        if (importBtn) importBtn.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'none';
    }
}

// ===== Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© =====
async function addUserInfoToUI() {
    try {
        await initGapi();
        gapi.client.setToken({ access_token: googleAccessToken });
        
        const response = await gapi.client.drive.about.get({
            fields: 'user'
        });
        
        const user = response.result.user;
        console.log('ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user);
        
        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
        // document.getElementById('userInfo').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName}`;
        
    } catch (error) {
        console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
    }
}

// ===== Ù…Ø³Ø­ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function clearAuthState() {
    localStorage.removeItem('googleAuth');
    isGoogleAuthenticated = false;
    googleAccessToken = null;
    updateAuthUI();
}

// ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Google =====
function handleGoogleLogout() {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø­Ø³Ø§Ø¨ GoogleØŸ')) {
        // Ø¥Ù„ØºØ§Ø¡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø¬Ø§Ù†Ø¨ Google
        if (googleAccessToken) {
            google.accounts.oauth2.revoke(googleAccessToken, () => {
                console.log('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙˆÙƒÙ†');
            });
        }
        
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        clearAuthState();
        
        alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
    }
}
// ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
function finalAuthCheck() {
    console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
    console.log('ğŸ”‘ isGoogleAuthenticated:', isGoogleAuthenticated);
    console.log('ğŸ”‘ googleAccessToken:', googleAccessToken ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    console.log('ğŸ”‘ localStorage googleAuth:', localStorage.getItem('googleAuth') ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    
    if (isGoogleAuthenticated && googleAccessToken) {
        console.log('ğŸ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    } else {
        console.log('â„¹ï¸ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    }
}

// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ...
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    setTimeout(finalAuthCheck, 1000);
});
// ===== Ù…ØµØ§Ø¯Ù‚Ø© Google - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…ØµØ­Ø­ =====
function handleGoogleAuth() {
    console.log('ğŸ” Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©...');
    
    if (typeof google === 'undefined') {
        alert('â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Google...');
        return;
    }

    // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­
    let authCompleted = false;

    try {
        const client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            prompt: 'consent',
            callback: (response) => {
                authCompleted = true;
                if (response && response.access_token) {
                    // Ù†Ø¬Ø­Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©!
                    googleAccessToken = response.access_token;
                    isGoogleAuthenticated = true;
                    
                    // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    saveAuthState(response);
                    updateAuthUI();
                    
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    setTimeout(() => {
                        showSyncOptions();
                    }, 1000);
                    
                } else {
                    alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„');
                }
            },
            error_callback: (error) => {
                // ÙÙ‚Ø· Ù†Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒØªÙ…Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­
                if (!authCompleted) {
                    console.error('ğŸ”´ Ø®Ø·Ø£ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
                    
                    if (error.type === 'popup_closed') {
                        alert('âš ï¸ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    } else {
                        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: ' + error.message);
                    }
                } else {
                    console.log('ğŸ”„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø£ØºÙ„Ù‚Øª Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ - Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ');
                }
            }
        });
        
        client.requestAccessToken();
        
    } catch (error) {
        console.error('ğŸ”´ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø©:', error);
        alert('âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + error.message);
    }
}

// ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª =====
function checkInternetConnection() {
    return navigator.onLine;
}

// ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ =====
async function checkCloudData() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
    if (!checkInternetConnection()) {
        return { 
            exists: false, 
            message: "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª",
            hasInternet: false
        };
    }

    try {
        await initGapi();
        gapi.client.setToken({ access_token: googleAccessToken });

        const response = await gapi.client.drive.files.list({
            q: "name='debt_backup.json' and trashed=false",
            fields: 'files(id, name, modifiedTime)',
            spaces: 'drive'
        });

        const files = response.result.files;
        
        if (files.length === 0) {
            return { 
                exists: false, 
                message: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ©",
                hasInternet: true
            };
        }

        const cloudFile = files[0];
        const cloudTime = new Date(cloudFile.modifiedTime);
        const lastBackup = localStorage.getItem('lastBackupTime');
        const localTime = lastBackup ? new Date(lastBackup) : null;
        
        return {
            exists: true,
            cloudTime: cloudTime,
            localTime: localTime,
            fileId: cloudFile.id,
            isNewer: localTime ? cloudTime > localTime : true,
            hasInternet: true
        };
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©:', error);
        return { 
            exists: false, 
            message: "ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©",
            hasInternet: false,
            error: error.message
        };
    }
}

// ===== Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© =====
async function showSyncOptions() {
    try {
        const cloudCheck = await checkCloudData();
        
        let message = 'ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n';
        
        if (!cloudCheck.hasInternet) {
            message += 'ğŸŒ ' + cloudCheck.message + '\n\n';
            message += 'â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.';
            alert(message);
            return;
        }
        
        if (cloudCheck.exists) {
            message += `ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ø³Ø­Ø§Ø¨ÙŠ: ${cloudCheck.cloudTime.toLocaleString('ar-EG')}\n`;
            
            if (cloudCheck.localTime) {
                message += `ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ: ${cloudCheck.localTime.toLocaleString('ar-EG')}\n\n`;
                
                if (cloudCheck.isNewer) {
                    message += 'ğŸ’¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.\n';
                } else {
                    message += 'ğŸ’¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£Ø­Ø¯Ø« Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.\n';
                }
            }
            
            message += '\nÙ…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ØŸ\n\n';
            message += 'Ù…ÙˆØ§ÙÙ‚: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive\n';
            message += 'Ø¥Ù„ØºØ§Ø¡: Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Google Drive';
        } else {
            message += 'ğŸŒ¥ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ©.\n\n';
            message += 'Ù…ÙˆØ§ÙÙ‚: Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Google Drive\n';
            message += 'Ø¥Ù„ØºØ§Ø¡: Ù„Ø§ Ø£ÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ Ø§Ù„Ø¢Ù†';
        }
        
        const choice = confirm(message);
        
        if (choice) {
            if (cloudCheck.exists) {
                importFromDrive();
            } else {
                syncWithDrive();
            }
        } else if (cloudCheck.exists) {
            syncWithDrive();
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:', error);
        showBasicSyncOptions();
    }
}

// ===== Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø®Ø·Ø£ =====
function showBasicSyncOptions() {
    const choice = confirm(
        'ğŸ‰ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\n' +
        'Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ØŸ\n\n' +
        'Ù…ÙˆØ§ÙÙ‚: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive\n' +
        'Ø¥Ù„ØºØ§Ø¡: Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Google Drive'
    );
    
    if (choice) {
        importFromDrive();
    } else {
        if (clients.length > 0 || transactions.length > 0) {
            if (confirm('âš ï¸ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Google DriveØŸ')) {
                syncWithDrive();
            }
        } else {
            alert('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ø±ÙØ¹Ù‡Ø§.');
        }
    }
}

        // ===== Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Drive =====
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
// ===== Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Drive =====
// ===== Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ =====
async function syncWithDrive() {
    if (!isGoogleAuthenticated) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
    if (!checkInternetConnection()) {
        alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return;
    }

    try {
        console.log('ğŸ”¼ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© GAPI...');
        await initGapi();
        
        gapi.client.setToken({ access_token: googleAccessToken });

        console.log('ğŸ”¼ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Drive...');
        
        const data = {
            clients: JSON.parse(localStorage.getItem('debtClients') || '[]'),
            transactions: JSON.parse(localStorage.getItem('debtTransactions') || '[]'),
            lastSync: new Date().toLocaleString('ar-EG')
        };

        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });

        await findOrCreateDriveFile(blob);
        
        // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©
        localStorage.setItem('lastBackupTime', new Date().toISOString());
        
        alert('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Drive Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:', error);
        
        if (error.message.includes('network') || error.message.includes('Internet')) {
            alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        } else {
            alert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        }
    }
}


// ===== Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙÙŠ Drive =====
async function findOrCreateDriveFile(blob) {
    try {
        const response = await gapi.client.drive.files.list({
            q: "name='debt_backup.json' and trashed=false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;
        
        if (files.length > 0) {
            await updateDriveFile(files[0].id, blob);
        } else {
            await createDriveFile(blob);
        }
    } catch (error) {
        throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù: ' + error.message);
    }
}

// ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive =====
async function importFromDrive() {
    if (!isGoogleAuthenticated) {
        alert('âŒ ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹
    if (!checkInternetConnection()) {
        alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        return;
    }

    if (!confirm('âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Drive. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
        return;
    }

    try {
        console.log('ğŸ”½ Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© GAPI...');
        await initGapi();
        
        gapi.client.setToken({ access_token: googleAccessToken });

        console.log('ğŸ”½ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„Ù...');
        const response = await gapi.client.drive.files.list({
            q: "name='debt_backup.json' and trashed=false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;
        
        if (files.length === 0) {
            alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Drive');
            return;
        }

        console.log('ğŸ”½ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');
        const fileResponse = await gapi.client.drive.files.get({
            fileId: files[0].id,
            alt: 'media'
        });

        const data = fileResponse.result;

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        clients = data.clients || [];
        transactions = data.transactions || [];
        localStorage.setItem('authenticated', 'true');
        saveData();
        updateStats();
        displayClients();
        displayTransactions();
        
        alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Drive Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
        
        if (error.message.includes('network') || error.message.includes('Internet')) {
            alert('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        } else {
            alert('âŒ ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
        }
    }
}
        // ===== ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Drive =====
        function updateDriveFile(fileId, blob) {
            return new Promise((resolve, reject) => {
                const metadata = {
                    name: 'debt_backup.json',
                    mimeType: 'application/json'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    },
                    body: form
                }).then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        reject(new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive'));
                    }
                }).catch(reject);
            });
        }

        // ===== Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ÙÙŠ Drive =====
        function createDriveFile(blob) {
            return new Promise((resolve, reject) => {
                const metadata = {
                    name: 'debt_backup.json',
                    mimeType: 'application/json'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`
                    },
                    body: form
                }).then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        reject(new Error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ÙÙŠ Drive'));
                    }
                }).catch(reject);
            });
        }

    


        // Ø±Ù…Ø² Ø§Ù„Ø§Ù…Ø§Ù†
function generateHourlyCode(secret = "ABC123") {
    const now = new Date();
    const hour = now.getHours();
    const day = now.getDate();

    // Ù†Ø­ÙˆÙ„ ÙƒÙ„ Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¥Ù„Ù‰ Ø±Ù‚Ù… ÙˆÙ†Ø¬Ù…Ø¹Ù‡ Ù…Ø¹ Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„ÙŠÙˆÙ…
    let total = 0;
    for (let i = 0; i < secret.length; i++) {
        total += secret.charCodeAt(i) * (hour + 1) + day;
    }

    // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 6 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    const code = (total * 7).toString().slice(-6);
    return code;
}

function isAuthenticated() {
    return localStorage.getItem("authenticated") === "true";
}

function setAuthenticated() {
    localStorage.setItem("authenticated", "true");
}

function verifyLogin() {
    const code = document.getElementById("codeInput").value.trim().toUpperCase();
    const expectedCode = generateHourlyCode();

    if ( code === expectedCode) {
        setAuthenticated();
        document.getElementById("authModal").style.display = "none";
        document.getElementById("appContent").style.display = "block";
    } else {
    document.getElementById("errorMsg").innerHTML = `
        Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­. Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø·ÙˆØ±:
        <br>
        <a href="tel:+963986053607" style="display:inline-block; margin-top:10px; padding:8px 16px; background-color:#ef9a9a; color:#000; border-radius:5px; text-decoration:none;">
             Ø§ØªØµÙ„ Ø§Ù„Ø¢Ù† Ùˆ Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨ 2 Ø¯ÙˆÙ„Ø§Ø± ÙÙ‚Ø·
        </a>
    `;
}


}

window.onload = () => {
    if (isAuthenticated()) {
        document.getElementById("authModal").style.display = "none";
        document.getElementById("appContent").style.display = "block";
    }
};
// Ø¯Ø§Ù„Ø© ØªØ³ØªØ¯Ø¹Ù‰ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© gapi
function onGapiLoad() {
    console.log('âœ… Google APIs library loaded');
    // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
}
//ØªØ§Ø±ÙŠØ® Ø§Ø®Ø± Ø¯ÙØ¹Ø© 
function getLastPaymentDate(clientId) {
  const payments = transactions
    .filter(t => t.clientId === clientId && t.amount < 0)
    .map(t => new Date(t.dateTime));

  if (payments.length === 0) return null;

  return payments.reduce((latest, current) => current > latest ? current : latest);
}
//ÙÙ„ØªØ±Ø© Ø§Ù„Ø§Ø³Ù…Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
function getDebtorsByPeriod(daysThreshold) {
  const now = new Date();

  return clients.filter(client => {
    if (client.currentDebt <= 0) return false;

    const lastPayment = getLastPaymentDate(client.id);
    if (!lastPayment) return true; // Ù„Ù… ÙŠØ¯ÙØ¹ Ø£Ø¨Ø¯Ù‹Ø§

    const diffDays = Math.floor((now - lastPayment) / (1000 * 60 * 60 * 24));
    return diffDays >= daysThreshold;
  });
}
document.getElementById('filterDebtorsBtn').onclick = () => {
  const days = parseInt(document.getElementById('debtPeriodSelect').value);
  const resultsDiv = document.getElementById('debtorResults');
  resultsDiv.innerHTML = '';

  const filteredClients = getDebtorsByPeriod(days);

  if (filteredClients.length === 0) {
    resultsDiv.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²Ø¨Ø§Ø¦Ù† Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙˆØ·.</p>';
    return;
  }

  filteredClients.forEach(client => {
    const lastPayment = getLastPaymentDate(client.id);
    const lastDateStr = lastPayment ? lastPayment.toLocaleDateString('ar-EG') : 'Ù„Ù… ÙŠØ¯ÙØ¹ Ø£Ø¨Ø¯Ù‹Ø§';

    const item = document.createElement('div');
    item.textContent = `${client.name} - Ø¯ÙŠÙ†: ${client.currentDebt} - Ø¢Ø®Ø± Ø¯ÙØ¹Ø©: ${lastDateStr}`;
    resultsDiv.appendChild(item);
  });
};
    </script>
</body>
</html>